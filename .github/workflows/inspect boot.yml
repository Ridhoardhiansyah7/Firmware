name: Inspect Boot Image Metadata (AIK-Linux + MediaFire)

on:
  workflow_dispatch:
    inputs:
      IMG_URL:
        description: "MediaFire / direct boot.img URL"
        required: true
        type: string

jobs:
  inspect:
    runs-on: ubuntu-latest

    steps:
      # 1. Install dependencies
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y wget unzip curl grep sed

      # 2. Download boot.img (support MediaFire)
      - name: Download boot image
        run: |
          URL="${{ github.event.inputs.IMG_URL }}"
          # cek apakah link MediaFire
          if [[ "$URL" == *"mediafire.com"* ]]; then
            echo "Detected MediaFire link, extracting direct download URL..."
            # ambil halaman HTML
            HTML=$(curl -sL "$URL")
            # cari link direct download (MediaFire biasanya di <a href="https://download...">)
            DIRECT=$(echo "$HTML" | grep -o 'https://download[^"]*' | head -n 1)
            if [ -z "$DIRECT" ]; then
              echo "Cannot find direct download link!"
              exit 1
            fi
            echo "Direct download URL: $DIRECT"
            wget -O boot.img "$DIRECT"
          else
            wget -O boot.img "$URL"
          fi
          file boot.img
          ls -lh boot.img

      # 3. Download AIK-Linux
      - name: Download Android Image Kitchen Linux branch
        run: |
          wget -O aik.zip https://github.com/osm0sis/Android-Image-Kitchen/archive/refs/heads/AIK-Linux.zip
          unzip -o aik.zip
          mv Android-Image-Kitchen-AIK-Linux AIK
          chmod -R +x AIK/*

      # 4. Unpack boot.img
      - name: Unpack boot.img using AIK
        run: |
          mkdir -p split_img
          AIK/unpackimg.sh boot.img

      # 5. Show header metadata
      - name: Show boot image header
        run: |
          echo "===== BOOT IMAGE HEADER ====="
          cat split_img/boot.img-header || true
          echo ""
          echo "===== KEY METADATA ====="
          grep -E "page_size|kernel_offset|ramdisk_offset|second_offset|tags_offset" split_img/boot.img-header || true

      # 6. Upload artifact
      - name: Upload boot metadata
        uses: actions/upload-artifact@v4
        with:
          name: boot-metadata
          path: split_img/