name: Inspect Boot Image (Dynamic MediaFire)

on:
  workflow_dispatch:
    inputs:
      mediafire_url:
        description: "MediaFire share link"
        required: true
        type: string

jobs:
  inspect:
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y wget curl grep sed python3-pip

      - name: Install AOSP boot tools
        run: |
          pip install mkbootimg

      - name: Resolve MediaFire direct link
        id: resolve
        run: |
          URL="${{ github.event.inputs.mediafire_url }}"
          echo "Resolving MediaFire link..."
          PAGE=$(curl -L -s "$URL")
          DIRECT=$(echo "$PAGE" | grep -o 'https://download[^"]*' | head -n1)

          if [ -z "$DIRECT" ]; then
            echo "Failed to resolve direct link"
            exit 1
          fi

          echo "Direct link found"
          echo "direct_link=$DIRECT" >> $GITHUB_OUTPUT

      - name: Download boot.img
        run: |
          wget -O boot.img "${{ steps.resolve.outputs.direct_link }}"

      - name: Verify file
        run: |
          file boot.img
          ls -lh boot.img

      - name: Print boot header info
        run: |
          echo "===== BOOT HEADER INFO ====="
          unpack_bootimg --boot_img boot.img --format=mkbootimg