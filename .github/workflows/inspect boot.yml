name: Inspect Boot Image Metadata (AIK-Linux)

on:
  workflow_dispatch:
    inputs:
      IMG_URL:
        description: "Direct boot.img URL (MediaFire / direct)"
        required: true
        type: string

jobs:
  inspect:
    runs-on: ubuntu-latest

    steps:
      # 1. Install dependencies
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y wget unzip

      # 2. Download boot.img
      - name: Download boot image
        run: |
          wget -O boot.img "${{ github.event.inputs.IMG_URL }}"
          file boot.img
          ls -lh boot.img

      # 3. Download AIK-Linux
      - name: Download Android Image Kitchen Linux branch
        run: |
          wget -O aik.zip https://github.com/osm0sis/Android-Image-Kitchen/archive/refs/heads/AIK-Linux.zip
          unzip -o aik.zip
          mv Android-Image-Kitchen-AIK-Linux AIK
          chmod -R +x AIK/*

      # 4. Extract boot.img header only
      - name: Show boot.img header metadata
        run: |
          mkdir -p output
          # AIK punya script unpackimg.sh, tapi header ada di split_img/boot.img-header
          AIK/unpackimg.sh boot.img
          echo "===== BOOT IMAGE HEADER ====="
          cat split_img/boot.img-header
          echo ""
          echo "===== KEY METADATA ====="
          # Ambil page size, kernel offset, ramdisk offset, second offset, tags offset
          grep -E "page_size|kernel_offset|ramdisk_offset|second_offset|tags_offset" split_img/boot.img-header || true

      # 5. Upload artifact (optional)
      - name: Upload boot metadata
        uses: actions/upload-artifact@v4
        with:
          name: boot-metadata
          path: split_img/