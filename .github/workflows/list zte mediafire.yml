name: Universal Firmware Lister

on:
  workflow_dispatch:
    inputs:
      firmware_url:
        description: "MediaFire page OR direct firmware link (.zip/.rar/.7z)"
        required: true
      extract_files:
        description: "Extract files? (true/false)"
        required: true
        default: "false"

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          sudo apt update
          sudo apt install -y p7zip-full unzip unrar aria2 curl file

      # =============================
      # Detect if MediaFire page
      # =============================
      - name: Detect MediaFire Direct Link
        id: link
        run: |
          URL="${{ github.event.inputs.firmware_url }}"

          if echo "$URL" | grep -q "mediafire.com/file"; then
            echo "MediaFire page detected"
            page=$(curl -sL "$URL")
            direct=$(echo "$page" | grep -o 'https://download[^"]*')
            echo "direct_url=$direct" >> $GITHUB_OUTPUT
          else
            echo "Direct link detected"
            echo "direct_url=$URL" >> $GITHUB_OUTPUT
          fi

      # =============================
      # Download firmware
      # =============================
      - name: Download Firmware
        run: |
          aria2c -x 16 -s 16 -k 1M "${{ steps.link.outputs.direct_url }}" -o firmware.bin

      # =============================
      # Detect archive type
      # =============================
      - name: Detect Archive Type
        id: detect
        run: |
          TYPE=$(file firmware.bin)
          echo "File type: $TYPE"

          if echo "$TYPE" | grep -qi zip; then
            echo "archive_type=zip" >> $GITHUB_OUTPUT
          elif echo "$TYPE" | grep -qi rar; then
            echo "archive_type=rar" >> $GITHUB_OUTPUT
          elif echo "$TYPE" | grep -qi "7-zip"; then
            echo "archive_type=7z" >> $GITHUB_OUTPUT
          else
            echo "Unsupported format"
            exit 1
          fi

      # =============================
      # List files inside archive
      # =============================
      - name: List Files Inside Archive
        run: |
          mkdir output

          if [ "${{ steps.detect.outputs.archive_type }}" = "zip" ]; then
            unzip -l firmware.bin > output/firmware_file_list.txt
          elif [ "${{ steps.detect.outputs.archive_type }}" = "rar" ]; then
            7z l firmware.bin > output/firmware_file_list.txt
          elif [ "${{ steps.detect.outputs.archive_type }}" = "7z" ]; then
            7z l firmware.bin > output/firmware_file_list.txt
          fi

          cat output/firmware_file_list.txt

      # =============================
      # Optional Extraction
      # =============================
      - name: Extract Archive (Optional)
        if: ${{ github.event.inputs.extract_files == 'true' }}
        run: |
          mkdir extracted

          if [ "${{ steps.detect.outputs.archive_type }}" = "zip" ]; then
            unzip firmware.bin -d extracted
          elif [ "${{ steps.detect.outputs.archive_type }}" = "rar" ]; then
            7z x firmware.bin -oextracted
          elif [ "${{ steps.detect.outputs.archive_type }}" = "7z" ]; then
            7z x firmware.bin -oextracted
          fi

          echo "Extraction complete"
          ls -lah extracted

      # =============================
      # Upload Results
      # =============================
      - name: Upload File List
        uses: actions/upload-artifact@v4
        with:
          name: firmware-file-list
          path: output/firmware_file_list.txt

      - name: Upload Extracted Files
        if: ${{ github.event.inputs.extract_files == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: extracted-firmware
          path: extracted/