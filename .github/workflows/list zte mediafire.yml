name: OTA Payload Inspector + Vendor EXT4 Converter

on:
  workflow_dispatch:
    inputs:
      firmware_url:
        description: "MediaFire page OR direct archive link"
        required: true
      full_dump:
        description: "Dump full payload images? (true/false)"
        required: true
        default: "true"

jobs:
  inspect:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # =========================================
      # Install Tools
      # =========================================
      - name: Install Tools
        run: |
          sudo apt update
          sudo apt install -y \
            p7zip-full aria2 curl file golang-go \
            liblzma-dev zip erofs-utils git \
            e2fsprogs android-sdk-libsparse-utils

      # =========================================
      # Resolve MediaFire Direct Link
      # =========================================
      - name: Resolve Download Link
        id: link
        run: |
          URL="${{ github.event.inputs.firmware_url }}"
          if echo "$URL" | grep -q "mediafire.com/file"; then
            page=$(curl -sL "$URL")
            direct=$(echo "$page" | grep -o 'https://download[^"]*')
            echo "direct_url=$direct" >> $GITHUB_OUTPUT
          else
            echo "direct_url=$URL" >> $GITHUB_OUTPUT
          fi

      # =========================================
      # Download Firmware
      # =========================================
      - name: Download Firmware
        run: |
          aria2c -x 16 -s 16 -k 1M "${{ steps.link.outputs.direct_url }}" -o firmware.bin

      # =========================================
      # Extract update.zip
      # =========================================
      - name: Extract update.zip
        run: |
          mkdir -p level2
          INNER=$(7z l -slt firmware.bin | grep -i "Path = " | grep -i "update.zip" | sed 's/Path = //' | head -n1)
          7z e firmware.bin "$INNER" -olevel2

      # =========================================
      # Extract payload.bin
      # =========================================
      - name: Extract payload.bin
        run: |
          mkdir -p payload
          7z e level2/update.zip payload.bin payload_properties.txt -opayload

      # =========================================
      # Install payload-dumper-go
      # =========================================
      - name: Install payload-dumper-go
        run: |
          go install github.com/ssut/payload-dumper-go@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      # =========================================
      # Dump partitions
      # =========================================
      - name: Dump payload partitions
        if: ${{ github.event.inputs.full_dump == 'true' }}
        run: |
          mkdir -p dumped
          payload-dumper-go -o dumped payload/payload.bin | sed -r 's/\x1B\[[0-9;]*[A-Za-z]//g'
          ls -lh dumped

      # =========================================
      # Convert vendor.img (EROFS -> EXT4)
      # =========================================
      - name: Convert vendor to EXT4
        if: ${{ github.event.inputs.full_dump == 'true' }}
        run: |
          mkdir -p vendor_extract

          echo "Detect filesystem:"
          FSINFO=$(file dumped/vendor.img)
          echo "$FSINFO"

          if echo "$FSINFO" | grep -qi "erofs"; then
            echo "EROFS detected. Extracting..."

            fsck.erofs --extract=vendor_extract dumped/vendor.img

            echo "Calculating required size..."
            SIZE=$(du -sb vendor_extract | cut -f1)
            FINAL_SIZE=$((SIZE + 300*1024*1024))

            echo "Creating EXT4 image..."
            dd if=/dev/zero of=vendor_ext4.img bs=1 count=0 seek=$FINAL_SIZE
            mkfs.ext4 -F vendor_ext4.img

            mkdir -p ext_mount
            sudo mount -o loop vendor_ext4.img ext_mount

            echo "Copying files..."
            sudo cp -a vendor_extract/* ext_mount/

            sudo umount ext_mount

          else
            echo "Already EXT filesystem, copying..."
            cp dumped/vendor.img vendor_ext4.img
          fi

          echo "Final EXT4 image:"
          ls -lh vendor_ext4.img

      # =========================================
      # Convert to Sparse (Android format)
      # =========================================
      - name: Create sparse image
        if: ${{ github.event.inputs.full_dump == 'true' }}
        run: |
          img2simg vendor_ext4.img vendor_ext4_sparse.img || true
          ls -lh vendor_ext4_sparse.img || true

      # =========================================
      # Upload artifacts
      # =========================================
      - name: Upload EXT4 vendor
        if: ${{ github.event.inputs.full_dump == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: vendor-ext4
          path: |
            vendor_ext4.img
            vendor_ext4_sparse.img