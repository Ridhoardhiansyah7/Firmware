name: Nested Firmware Viewer

on:
  workflow_dispatch:
    inputs:
      firmware_url:
        description: "MediaFire page OR direct firmware link"
        required: true

jobs:
  inspect:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          sudo apt update
          sudo apt install -y p7zip-full unzip unrar aria2 curl file

      # =========================================
      # Detect MediaFire or Direct Link
      # =========================================
      - name: Get Direct Link
        id: link
        run: |
          URL="${{ github.event.inputs.firmware_url }}"

          if echo "$URL" | grep -q "mediafire.com/file"; then
            echo "MediaFire page detected"
            page=$(curl -sL "$URL")
            direct=$(echo "$page" | grep -o 'https://download[^"]*')
            echo "direct_url=$direct" >> $GITHUB_OUTPUT
          else
            echo "Direct link detected"
            echo "direct_url=$URL" >> $GITHUB_OUTPUT
          fi

      # =========================================
      # Download Firmware
      # =========================================
      - name: Download Firmware
        run: |
          aria2c -x 16 -s 16 -k 1M "${{ steps.link.outputs.direct_url }}" -o firmware.bin

      # =========================================
      # Detect Archive Type
      # =========================================
      - name: Detect Archive Type
        id: detect
        run: |
          TYPE=$(file firmware.bin)
          echo "Detected: $TYPE"

          if echo "$TYPE" | grep -qi zip; then
            echo "archive_type=zip" >> $GITHUB_OUTPUT
          elif echo "$TYPE" | grep -qi rar; then
            echo "archive_type=rar" >> $GITHUB_OUTPUT
          elif echo "$TYPE" | grep -qi "7-zip"; then
            echo "archive_type=7z" >> $GITHUB_OUTPUT
          else
            echo "Unsupported format"
            exit 1
          fi

      # =========================================
      # List Level 1 Archive
      # =========================================
      - name: List Level 1 Archive
        run: |
          echo "===== LEVEL 1 CONTENT ====="
          7z l firmware.bin | tee level1.txt

      # =========================================
      # Extract update.zip ONLY (if exists)
      # =========================================
      - name: Extract update.zip (if exists)
        run: |
          mkdir level2

          INNER=$(7z l firmware.bin | grep -i "update.zip" | awk '{print $6}' | head -n1)

          if [ -n "$INNER" ]; then
            echo "Found nested archive: $INNER"
            7z e firmware.bin "$INNER" -olevel2
          else
            echo "No update.zip found"
          fi

      # =========================================
      # List update.zip Content (No Extract)
      # =========================================
      - name: List update.zip Content
        run: |
          if [ -f level2/update.zip ]; then
            echo "===== LEVEL 2 (update.zip) CONTENT ====="
            7z l level2/update.zip | tee level2.txt
          else
            echo "No nested update.zip to inspect"
          fi

      # =========================================
      # Cleanup to Save Disk
      # =========================================
      - name: Cleanup
        run: |
          rm -rf level2
          echo "Temporary files cleaned"